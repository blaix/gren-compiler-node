module Test.CLI.Parser exposing (tests)

import Expect exposing (Expectation)
import Test exposing (Test, describe, test)
import CLI.Parser as Parser
import FileSystem.Path as Path




tests : Test
tests =
    describe "CLI Parser"
        [ test "Parses successfully" <| \{} -> 
            Expect.ok <| Parser.run testCmd testArgs
        , describe "Args"
            [ test "Args in valid example is parsed correctly" <| \{} ->
                expectParseSuccess testCmd testArgs <| \cmd ->
                    Expect.equal
                        [ Path.fromPosixString "src/Main.gren" ]
                        cmd.args
            ]
        , describe "Flags"
            [ test "Flags in valid example are parsed correctly" <| \{} -> 
                expectParseSuccess testCmd testArgs <| \cmd ->
                    Expect.equal 
                        { debug = True
                        , output = Path.fromPosixString "out"
                        }
                        cmd.flags
            , test "Leaving out a toggle flag means it's false" <| \{} -> 
                expectParseSuccess testCmd (Array.filter (\f -> f /= "--debug") testArgs) <| \cmd ->
                    Expect.equal False cmd.flags.debug
            ]
        ] 


expectParseSuccess : Parser.Command args flags result -> Array String -> (result -> Expectation) -> Expectation
expectParseSuccess cmd args next =
    case Parser.run cmd args of
        Err _ ->
            Expect.fail "Failed to parse"

        Ok result ->
            next result


testArgs : Array String
testArgs =
    [ "make", "--debug", "--output=out", "src/Main.gren" ]


testCmd =
    { word =
        "make"
    , arguments =
        Parser.zeroOrMoreArgs Parser.grenFileParser
    , flags =
        Parser.initFlags 
            (\debug output ->
                { debug = debug
                , output = output
                }
            )
            |> Parser.onOff "debug" "debug desc"
            |> Parser.flag "output" Parser.pathParser "output path"
    , commonDescription =
        Just "make your project"
    , summary =
        "Makey make make"
    , example = "gren make src/Main.gren"
    , builder =
        \args flags ->
            { args = args
            , flags = flags
            }
    }
